# Core behavior
set -g bell-action any
set -g detach-on-destroy off
set -g prefix C-]
set -g status-interval 5
set -g display-time 1000
set -g history-limit 100000
set -sg escape-time 0
set -g mouse on

# Window/pane behavior
set -g base-index 1
setw -g pane-base-index 1
setw -g aggressive-resize on
setw -g automatic-rename on
setw -g mode-keys vi
setw -g monitor-activity off
set -g visual-activity off
set -g focus-events on

# Terminal capability
# Use tmux terminfo so TUI apps (e.g. lazygit) get the expected capabilities.
set -g default-terminal "tmux-256color"
set -as terminal-features ",tmux-256color:RGB,xterm-256color:RGB"
set -g terminal-overrides 'xterm-256color*:smcup@:rmcup@'
set -g set-clipboard external
set-environment -g COLORTERM truecolor
# Ensure color-disabled env vars from parent shells do not leak into tmux apps.
set-environment -gu NO_COLOR
set-environment -gu ANSI_COLORS_DISABLED
set-environment -gu NODE_DISABLE_COLORS

# OSC 52 passthrough (supported tmux versions only)
if-shell "tmux show-options -gqv allow-passthrough >/dev/null 2>&1" {
    set -g allow-passthrough on
}

# Statusline style
set -g status-style "fg=colour252,bg=colour234"
set -g message-style "fg=colour252,bg=colour238"
setw -g window-status-style "fg=colour244,bg=colour234,dim"
setw -g window-status-activity-style "fg=colour214,bg=colour234,bold"
set -g status-left-length 64
set -g status-right-length 451
set -g status-left '#[fg=colour235,bg=colour252,bold] ❐ #P #[fg=colour252,bg=colour236,bold] #H:#S  '
set -g status-right '#[fg=colour252,bg=colour236,bold] #{user}@#H · %a · %Y-%m-%d · %H:%M '
set -g window-status-separator ' '
set -g window-status-format "#[fg=colour252,bg=colour238,bold] #I· #W "
set -g window-status-current-format "#[fg=black,bg=colour81,noreverse,bold] #I· #W "

# UI colors
set -g display-panes-active-colour colour33
set -g display-panes-colour colour166
setw -g clock-mode-colour colour64

# Unbind defaults we do not use
unbind C-h
unbind C-j
unbind C-k
unbind C-l
unbind C-[
unbind C-]
unbind-key -T prefix [
unbind-key -T prefix n
unbind-key -T prefix p
unbind-key -T prefix N

# Copy mode (vi)
bind-key -T copy-mode-vi r send -X rectangle-toggle
bind-key -T copy-mode-vi v send -X begin-selection
bind-key -T copy-mode-vi V send -X select-line

# Clipboard command selection
# Note: actual copy-mode bindings are applied after TPM load below.
set -g @copy_command ""

if-shell "uname | grep -q Darwin" {
    if-shell "command -v reattach-to-user-namespace >/dev/null 2>&1" {
        set -g @copy_command "reattach-to-user-namespace pbcopy"
    } {
        set -g @copy_command "pbcopy"
    }
}

if-shell "uname | grep -qi microsoft" {
    set -g @copy_command "clip.exe"
}

# Linux clipboard backends (fallback only)
if-shell -F '#{==:#{@copy_command},}' {
    if-shell "uname | grep -q Linux" {
        if-shell "command -v wl-copy >/dev/null 2>&1" {
            set -g @copy_command "wl-copy"
        } {
            if-shell "command -v xclip >/dev/null 2>&1" {
                set -g @copy_command "xclip -in -selection clipboard"
            } {
                if-shell "command -v xsel >/dev/null 2>&1" {
                    set -g @copy_command "xsel --clipboard --input"
                }
            }
        }
    }
}

# Prefix navigation
bind-key C-] last-window
bind-key C-[ next-window
bind-key C-o select-pane -t :.-

# Non-prefix navigation
bind-key -n M-'}' next-window
bind-key -n M-'{' previous-window
bind-key -n C-Left select-window -t :-
bind-key -n C-Right select-window -t :+
bind-key -n C-Up select-pane -t :.-
bind-key -n C-Down select-pane -t :.+

# Pane direct select (Meta+1..9)
bind-key -n M-1 select-pane -t 1
bind-key -n M-2 select-pane -t 2
bind-key -n M-3 select-pane -t 3
bind-key -n M-4 select-pane -t 4
bind-key -n M-5 select-pane -t 5
bind-key -n M-6 select-pane -t 6
bind-key -n M-7 select-pane -t 7
bind-key -n M-8 select-pane -t 8
bind-key -n M-9 select-pane -t 9
bind-key -n M-0 copy-mode

# Linux: quick copy-mode enter
if-shell "uname | grep -q Linux" {
    bind-key Escape copy-mode
}

# Session/window/pane controls
bind-key k send-keys C-l \; clear-history
bind-key i set-window-option synchronize-panes on
bind-key u set-window-option synchronize-panes off
# Layout controls: forward/reverse cycle + quick even rebalance.
unbind-key Space
bind-key -r Space next-layout
bind-key -r BSpace select-layout -p
bind-key = select-layout -E
# Pane resize: arrows for fine steps, Shift+H/J/K/L for coarse steps.
bind-key -r Up resize-pane -U 5
bind-key -r Down resize-pane -D 5
bind-key -r Left resize-pane -L 5
bind-key -r Right resize-pane -R 5
bind-key -r H resize-pane -L 12
bind-key -r J resize-pane -D 12
bind-key -r K resize-pane -U 12
bind-key -r L resize-pane -R 12

bind '"' split-window -c "#{pane_current_path}"
bind % split-window -h -c "#{pane_current_path}"
bind c new-window -c "#{pane_current_path}"
bind n command-prompt -p "new session name" "new-session -s '%%' -c '#{pane_current_path}'"
bind N command-prompt -I "#S" -p "rename session" "rename-session '%%'"

# Popup shortcuts
if-shell "command -v hx >/dev/null 2>&1" {
    bind h display-popup -E -xC -yC -w 90% -h 90% -d "#{pane_current_path}" "hx ."
} {
    bind h display-message "hx not found. run: mise install"
}

if-shell "command -v lazygit >/dev/null 2>&1" {
    bind g display-popup -E -xC -yC -w 90% -h 90% -d "#{pane_current_path}" "env -u NO_COLOR -u ANSI_COLORS_DISABLED -u NODE_DISABLE_COLORS COLORTERM=truecolor lazygit -ucf \"$HOME/.config/lazygit/config.yml\""
} {
    bind g display-message "lazygit not found. run: mise install"
}

if-shell "command -v yazi >/dev/null 2>&1" {
    bind y display-popup -E -xC -yC -w 90% -h 90% -d "#{pane_current_path}" "YAZI_CONFIG_HOME=$HOME/.config/yazi yazi"
} {
    bind y display-message "yazi not found. install yazi first"
}

# Utility
bind-key m set -g mouse \; display-message "Mouse: #{?mouse,On,Off}"
bind-key r source-file ~/.tmux.conf \; display-message "Config reloaded..."
# Join selected window into current window as a pane (prefix + j).
bind-key j choose-window "join-pane -h -s \"%%\""
bind-key S choose-window "join-pane -v -s \"%%\""
bind-key V choose-window "join-pane -h -s \"%%\""

# Plugins (TPM)
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @continuum-restore 'on'
set -g @continuum-save-interval '5'

if-shell "[ -x ~/.tmux/plugins/tpm/tpm ]" {
    run '~/.tmux/plugins/tpm/tpm'
}

# Apply clipboard bindings after plugin load (tmux-yank may override these).
if-shell -F '#{!=:#{@copy_command},}' {
    bind-key -T copy-mode-vi Y send -X copy-pipe-and-cancel "#{@copy_command}"
    bind-key -T copy-mode-vi y send -X copy-pipe "#{@copy_command}"
    unbind -T copy-mode-vi Enter
    bind-key -T copy-mode-vi Enter send -X copy-pipe-and-cancel "#{@copy_command}"
    bind-key -T copy-mode-vi MouseDragEnd1Pane send -X copy-pipe-and-cancel "#{@copy_command}"
}

# Keep command-prompt/status input in emacs style (prefix + :).
set -g status-keys emacs
