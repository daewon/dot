# Core behavior
set -g bell-action any
set -g detach-on-destroy off
set -g prefix C-]
set -g status-interval 5
set -g history-limit 100000
set -sg escape-time 0

# Window/pane behavior
set -g base-index 1
setw -g pane-base-index 1
setw -g aggressive-resize on
setw -g automatic-rename on
setw -g mode-keys vi
setw -g monitor-activity on
set -g visual-activity on
set -g focus-events on

# Terminal capability
set -g default-terminal "tmux-256color"
set -as terminal-features ",xterm-256color:RGB"
set -g terminal-overrides 'xterm-256color*:smcup@:rmcup@'
set -g set-clipboard on

# OSC 52 passthrough (supported tmux versions only)
if-shell "tmux show-options -gqv allow-passthrough >/dev/null 2>&1" {
    set -g allow-passthrough on
}

# Statusline style
set -g status-style "fg=colour136,bg=colour235"
setw -g window-status-style "fg=colour244,bg=default,dim"
set -g status-left-length 52
set -g status-right-length 451
set -g status-fg white
set -g status-bg colour234
set -g status-left '#[fg=colour235,bg=colour252,bold] ❐ #P #[fg=colour252,bg=colour238,nobold]⮀#[fg=colour245,bg=colour238,bold] #(whoami) #[fg=colour238,bg=colour234,nobold]⮀'
set -g status-right '#[fg=colour245,bg=colour238,bold] %H:%M %d-%b-%y #(hostname)'
set -g window-status-format "#[fg=colour235,bg=colour252,bold] #I #W "
set -g window-status-current-format "#[fg=colour234,bg=colour39]⮀#[fg=black,bg=colour39,noreverse,bold] #I: #W #[fg=colour39,bg=colour234,nobold]⮀"

# UI colors
set -g display-panes-active-colour colour33
set -g display-panes-colour colour166
setw -g clock-mode-colour colour64

# Unbind defaults we do not use
unbind C-h
unbind C-j
unbind C-k
unbind C-l
unbind C-[
unbind C-]
unbind [
unbind-key -T prefix [
unbind-key -T prefix n
unbind-key -T prefix p
unbind-key -T prefix N

# Copy mode (vi)
bind-key -T copy-mode-vi r send -X rectangle-toggle
bind-key -T copy-mode-vi v send -X begin-selection
bind-key -T copy-mode-vi V send -X select-line

# Clipboard: macOS
if-shell "uname | grep -q Darwin" {
    bind-key -T copy-mode-vi Y send -X copy-pipe-and-cancel "reattach-to-user-namespace pbcopy"
    bind-key -T copy-mode-vi y send -X copy-pipe "reattach-to-user-namespace pbcopy"
    unbind -T copy-mode-vi Enter
    bind-key -T copy-mode-vi Enter send -X copy-pipe-and-cancel "reattach-to-user-namespace pbcopy"
    bind-key -T copy-mode-vi MouseDragEnd1Pane send -X copy-pipe-and-cancel "reattach-to-user-namespace pbcopy"
}

# Clipboard: WSL
if-shell "uname | grep -qi microsoft" {
    bind-key -T copy-mode-vi Y send -X copy-pipe-and-cancel "clip.exe"
    bind-key -T copy-mode-vi y send -X copy-pipe "clip.exe"
    unbind -T copy-mode-vi Enter
    bind-key -T copy-mode-vi Enter send -X copy-pipe-and-cancel "clip.exe"
    bind-key -T copy-mode-vi MouseDragEnd1Pane send -X copy-pipe-and-cancel "clip.exe"
}

# Prefix navigation
bind-key C-] last-window
bind-key C-[ next-window
bind-key C-o select-pane -t :.-

# Non-prefix navigation
bind-key -n M-'}' next-window
bind-key -n M-'{' previous-window
bind-key -n C-Left select-window -t :-
bind-key -n C-Right select-window -t :+
bind-key -n C-Up select-pane -t :.-
bind-key -n C-Down select-pane -t :.+

# Pane direct select (Meta+1..9)
bind-key -n M-1 select-pane -t 1
bind-key -n M-2 select-pane -t 2
bind-key -n M-3 select-pane -t 3
bind-key -n M-4 select-pane -t 4
bind-key -n M-5 select-pane -t 5
bind-key -n M-6 select-pane -t 6
bind-key -n M-7 select-pane -t 7
bind-key -n M-8 select-pane -t 8
bind-key -n M-9 select-pane -t 9
bind-key -n M-0 copy-mode

# Linux: quick copy-mode enter
if-shell "uname | grep -q Linux" {
    bind-key Escape copy-mode
}

# Session/window/pane controls
bind-key k send-keys C-l \; clear-history
bind-key i set-window-option synchronize-panes on
bind-key u set-window-option synchronize-panes off
bind-key -r up resize-pane -U 15
bind-key -r down resize-pane -D 15
bind-key -r left resize-pane -L 10
bind-key -r right resize-pane -R 10

bind '"' split-window -c "#{pane_current_path}"
bind % split-window -h -c "#{pane_current_path}"
bind c new-window -c "#{pane_current_path}"
bind n command-prompt -p "new session name" "new-session -s '%%' -c '#{pane_current_path}'"

# Popup shortcuts
bind h display-popup -E -xC -yC -w 90% -h 90% -d "#{pane_current_path}" "hx ."
bind g display-popup -E -xC -yC -w 90% -h 90% -d "#{pane_current_path}" "lazygit"
bind y display-popup -E -xC -yC -w 90% -h 90% -d "#{pane_current_path}" "YAZI_CONFIG_HOME=$HOME/.config/yazi yazi"
bind-key j run-shell '~/.tmux/plugins/tmux/custom/popup.sh'

# Utility
bind-key m set -g mouse \; display-message "Mouse: #{?mouse,On,Off}"
bind-key r source-file ~/.tmux.conf \; display-message "Config reloaded..."
bind-key S choose-window "join-pane -v -s \"%%\""
bind-key V choose-window "join-pane -h -s \"%%\""

# Plugins (TPM)
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @continuum-restore 'on'

if-shell "[ -x ~/.tmux/plugins/tpm/tpm ]" {
    run '~/.tmux/plugins/tpm/tpm'
}
